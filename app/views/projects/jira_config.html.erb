<div class="max-w-4xl mx-auto">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Jira Integration</h1>
    <p class="text-gray-600">Project: <strong><%= @project.name %></strong></p>
  </div>

  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <h2 class="text-lg font-semibold text-blue-900 mb-2">ðŸ“‹ Setup Instructions</h2>
    <div class="text-sm text-blue-800 space-y-2">
      <ol class="list-decimal list-inside space-y-1 ml-2">
        <li><strong>Important:</strong> If you just installed the jira-ruby gem, please restart your Rails server first!</li>
        <li>Get your Jira API token from: <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank" class="underline">Atlassian Account Settings</a></li>
        <li>Your Jira site URL should be in format: <code class="bg-blue-100 px-1 rounded">https://your-domain.atlassian.net</code></li>
        <li>Project Key is the short key for your Jira project (e.g., "PROJ", "TEST")</li>
        <li>Use your Jira email address as the username</li>
        <li>Test the connection before saving</li>
      </ol>
    </div>
  </div>

  <% if alert %>
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
      <p class="text-red-700"><%= alert %></p>
    </div>
  <% end %>

  <% if @jira_service && @jira_service.errors.any? %>
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
      <p class="text-yellow-800 font-semibold mb-2">Jira Service Warnings:</p>
      <ul class="list-disc list-inside text-yellow-700">
        <% @jira_service.errors.each do |error| %>
          <li><%= error %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_with model: @project, url: update_jira_config_project_path(@project), class: "bg-white rounded-lg shadow-md p-6" do |form| %>
    <% if @project.errors.any? %>
      <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
        <ul class="list-disc list-inside text-red-700">
          <% @project.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="mb-4">
      <%= form.label :jira_site_url, "Jira Site URL", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_field :jira_site_url, 
                          placeholder: "https://your-domain.atlassian.net",
                          class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-sm text-gray-500">Your Jira instance URL</p>
    </div>

    <div class="mb-4">
      <%= form.label :jira_username, "Jira Username/Email", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.email_field :jira_username, 
                           placeholder: "your-email@example.com",
                           class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-sm text-gray-500">Your Jira account email address</p>
    </div>

    <div class="mb-4">
      <%= form.label :jira_api_token, "Jira API Token", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.password_field :jira_api_token, 
                              placeholder: "Enter your API token",
                              value: @project.jira_api_token.present? ? "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" : "",
                              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      <p class="mt-1 text-sm text-gray-500">
        <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank" class="text-blue-600 hover:underline">Generate API token</a>
      </p>
    </div>

    <div class="mb-4">
      <%= form.label :jira_project_key, "Jira Project Key", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_field :jira_project_key, 
                          placeholder: "PROJ",
                          class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase" %>
      <p class="mt-1 text-sm text-gray-500">The short key for your Jira project (e.g., PROJ, TEST)</p>
    </div>

    <div class="mb-6">
      <div class="flex items-center">
        <%= form.check_box :sync_enabled, class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" %>
        <%= form.label :sync_enabled, "Enable automatic sync", class: "ml-2 block text-sm text-gray-700" %>
      </div>
      <p class="mt-1 text-sm text-gray-500 ml-6">When enabled, changes will sync automatically (future feature)</p>
    </div>

    <div class="flex space-x-4">
      <button type="button" id="test-connection-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
        Test Connection
      </button>
      <%= form.submit "Save Configuration", class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" %>
      <%= link_to "Cancel", @project, class: "bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg" %>
    </div>
  <% end %>

  <div id="connection-result" class="mt-4 hidden"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const testBtn = document.getElementById('test-connection-btn');
    const resultDiv = document.getElementById('connection-result');
    const form = document.querySelector('form');

    testBtn.addEventListener('click', function() {
      const formData = new FormData(form);
      const data = {
        project: {
          jira_site_url: formData.get('project[jira_site_url]'),
          jira_username: formData.get('project[jira_username]'),
          jira_api_token: formData.get('project[jira_api_token]'),
          jira_project_key: formData.get('project[jira_project_key]')
        }
      };

      testBtn.disabled = true;
      testBtn.textContent = 'Testing...';

      fetch('<%= test_jira_connection_project_path(@project) %>', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        resultDiv.classList.remove('hidden');
        if (data.success) {
          resultDiv.className = 'mt-4 bg-green-50 border border-green-200 rounded-lg p-4';
          resultDiv.innerHTML = '<p class="text-green-800"><strong>âœ“ Success!</strong> ' + data.message + '</p>';
        } else {
          resultDiv.className = 'mt-4 bg-red-50 border border-red-200 rounded-lg p-4';
          resultDiv.innerHTML = '<p class="text-red-800"><strong>âœ— Failed:</strong> ' + data.message + '</p>';
        }
      })
      .catch(error => {
        resultDiv.classList.remove('hidden');
        resultDiv.className = 'mt-4 bg-red-50 border border-red-200 rounded-lg p-4';
        resultDiv.innerHTML = '<p class="text-red-800"><strong>âœ— Error:</strong> ' + error.message + '</p>';
      })
      .finally(() => {
        testBtn.disabled = false;
        testBtn.textContent = 'Test Connection';
      });
    });
  });
</script>

